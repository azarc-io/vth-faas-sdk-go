syntax = "proto3";
package sdk_v1;
option go_package = "github.com/azarc-io/vth-faas-sdk-go/pkg/api/v1;sdk_v1";

import "google/protobuf/struct.proto";

/************************************************************************/
/* COMMON
/************************************************************************/

message Void {}

message Error {
  string error = 1;
  uint32 error_code = 2;
  ErrorType error_type = 3;
}

/************************************************************************/
/* ENUMS
/************************************************************************/

enum ErrorType {
  Failed = 0;
  Canceled = 1;
  Skip = 2;
  Retry = 3;
}

enum StageStatus {
  StagePending = 0;
  StageStarted = 1;
  StageCompleted = 2;
  StageFailed = 3;
  StageSkipped = 4;
  StageCanceled = 5;
}

enum JobStatus {
  JobWaiting = 0;
  JobRunning = 1;
  JobDone = 2;
  JobCanceled = 3;
  JobCompletionStarted = 4;
  JobCompletionDone = 5;
  JobCompletionDoneWithErrors = 6;
  JobCompensationStarted = 7;
  JobCompensationDone = 8;
  JobCompensationDoneWithErrors = 9;
  JobCancellationStarted = 10;
  JobCancellationDone = 11;
  JobCancellationDoneWithErrors = 12;
}

/************************************************************************/
/* JOB
/************************************************************************/

message ExecuteJobRequest {
  string key = 1;
  string transaction_id = 2;
  string correlation_id = 3;
  string last_active_stage = 4;
  StageStatus last_active_status = 5;
}

message SetJobStatusRequest {
  string key = 1;
  JobStatus status = 2;
  optional Error err = 3;
}

message RegisterHeartbeatsRequest {
  repeated string job_keys = 1;
}

/************************************************************************/
/* STAGE
/************************************************************************/

message StageResult {
  google.protobuf.Value data = 1;
}

message SetStageStatusRequest {
  string name = 1;
  string job_key = 2;
  StageStatus status = 3;
  Error err = 4;
}

message GetStageResultRequest {
  string name = 1;
  string job_key = 2;
}

message GetStageResultResponse {
  StageResult result = 1;
}

message SetStageResultRequest {
  string job_key = 1;
  string name = 2;
  StageResult result = 3;
}

/************************************************************************/
/* VARIABLE
/************************************************************************/

message Variable {
  string name = 1;
  google.protobuf.Value value = 2;
  string mime_type = 3;
}

message GetVariableRequest {
  string name = 1;
  string stage = 2;
  string job_key = 3;
}

message GetVariableResponse {
  Variable variable = 1;
}

message SetVariableRequest {
  string name = 1;
  string stage = 2;
  string job_key = 3;
  Variable variable = 4;
}

/************************************************************************/
/* AGENT
/************************************************************************/

service AgentService {
  rpc ExecuteJob(ExecuteJobRequest) returns (Void);
}

/************************************************************************/
/* MANAGER
/************************************************************************/

service ManagerService {
  rpc SetStageStatus(SetStageStatusRequest) returns (Void);

  rpc GetStageResult(GetStageResultRequest) returns (GetStageResultResponse);
  rpc SetStageResult(SetStageResultRequest) returns (Void);

  rpc GetVariable(GetVariableRequest) returns (GetVariableResponse);
  rpc SetVariable(SetVariableRequest) returns (Void);

  rpc SetJobStatus(SetJobStatusRequest) returns (Void);
  rpc RegisterHeartbeats(RegisterHeartbeatsRequest) returns (Void);
}