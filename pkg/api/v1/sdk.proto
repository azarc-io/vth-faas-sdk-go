syntax = "proto3";
package sdk_v1;
option go_package = "github.com/azarc-io/vth-faas-sdk-go/pkg/api/v1;sdk_v1";

import "google/protobuf/struct.proto";
import "google/protobuf/timestamp.proto";

/************************************************************************/
/* COMMON
/************************************************************************/

message Void {}

message Error {
  string error = 1;
  uint32 error_code = 2;
  ErrorType error_type = 3;
  optional RetryStrategy retry = 4;
  optional google.protobuf.Value metadata = 5;
}

message RetryStrategy {
  uint32 backoff = 1;
  uint32 count = 2;
}

/************************************************************************/
/* ENUMS
/************************************************************************/

enum ErrorType {
  Failed = 0;
  Canceled = 1;
  Skip = 2;
  Retry = 3;
}

enum StageType {
  Standard = 0;
  Compensate = 1;
  Cancel = 2;
  Complete = 3;
}

enum StageStatus {
  StagePending = 0;
  StageStarted = 1;
  StageCompleted = 2;
  StageFailed = 3;
  StageSkipped = 4;
  StageCanceled = 5;
}

/************************************************************************/
/* JOB
/************************************************************************/

message LastActiveStage {
  string name = 1;
  StageStatus status = 2;
}

message ExecuteJobRequest {
  string key = 1;
  string transaction_id = 2;
  string correlation_id = 3;
  LastActiveStage last_active_stage = 4;
}

message ExecuteJobResponse {
  string service_id = 1;
}

message RegisterHeartbeatRequest {
  string service_id = 1;
}

/************************************************************************/
/* STAGE
/************************************************************************/

message SetStageStatusRequest {
  string name = 1;
  string job_key = 2;
  uint32 level = 3;
  StageStatus status = 4;
  Error err = 5;
}

message GetStageResultRequest {
  string name = 1;
  string job_key = 2;
}

message GetStageResultResponse {
  bytes data = 1;
}

message SetStageResultRequest {
  string job_key = 1;
  string name = 2;
  bytes data = 3;
}

message GetStageStatusRequest {
  string job_key = 1;
  string name = 2;
}

message GetStageStatusResponse {
  StageStatus status = 1;
}

/************************************************************************/
/* VARIABLE
/************************************************************************/

message Variable {
  string name = 1;
  google.protobuf.Value value = 2;
  string mime_type = 3;
}

message GetVariablesRequest {
  string job_key = 1;
  repeated string name = 2;
}

message GetVariablesResponse {
  map<string, Variable> variables = 1;
}

message SetVariablesRequest {
  string job_key = 1;
  map<string, Variable> variables = 2;
}

/************************************************************************/
/* AGENT
/************************************************************************/

service AgentService {
  rpc ExecuteJob(ExecuteJobRequest) returns (ExecuteJobResponse);
}

/************************************************************************/
/* MANAGER
/************************************************************************/

service ManagerService {
  rpc GetStageStatus(GetStageStatusRequest) returns (GetStageStatusResponse);
  rpc SetStageStatus(SetStageStatusRequest) returns (Void);

  rpc GetStageResult(GetStageResultRequest) returns (GetStageResultResponse);
  rpc SetStageResult(SetStageResultRequest) returns (Void);

  rpc GetVariables(GetVariablesRequest) returns (GetVariablesResponse);
  rpc SetVariables(SetVariablesRequest) returns (Void);

  rpc RegisterHeartbeat(RegisterHeartbeatRequest) returns (Void);
}